/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/

var w=Object.defineProperty;var I=Object.getOwnPropertyDescriptor;var M=Object.getOwnPropertyNames;var D=Object.prototype.hasOwnProperty;var N=(h,i)=>{for(var e in i)w(h,e,{get:i[e],enumerable:!0})},k=(h,i,e,t)=>{if(i&&typeof i=="object"||typeof i=="function")for(let s of M(i))!D.call(h,s)&&s!==e&&w(h,s,{get:()=>i[s],enumerable:!(t=I(i,s))||t.enumerable});return h};var O=h=>k(w({},"__esModule",{value:!0}),h);var B={};N(B,{default:()=>E});module.exports=O(B);var R=require("obsidian");var b={MESSAGE:3e5,VERSION_CHECK:1e4},A={TEXTAREA_MAX_HEIGHT:120},x={claudePath:"claude",includeCurrentNote:!0,maxContextLength:5e4,autoCopyResponse:!1,historyLimit:50,autoApproveReadOnly:!0,rememberApprovedTools:!0,systemPrompt:`Obsidian vault \uD0D0\uC0C9 \uC2DC:
1. \uBA3C\uC800 obsidian_list_files_in_vault\uB85C \uC804\uCCB4 \uAD6C\uC870 \uD30C\uC545
2. \uB610\uB294 obsidian_simple_search\uB85C \uD3F4\uB354/\uD30C\uC77C \uAC80\uC0C9
3. \uBD88\uD544\uC694\uD55C \uBC18\uBCF5 \uD0D0\uC0C9 \uD558\uC9C0 \uB9D0 \uAC83`};var d=require("obsidian");var v="claude-view",S=class extends d.ItemView{constructor(e,t){super(e);this.messages=[];this.isLoading=!1;this.includeDocument=!0;this.includeSelection=!1;this.pendingSelectionContext=null;this.cliStatus={status:"ready"};this.currentLoadingEl=null;this.loadingStartTime=0;this.isComposing=!1;this.lastUserRequest=null;this.displayedDeniedTools=new Set;this.plugin=t,this.includeDocument=t.settings.includeCurrentNote}getViewType(){return v}getDisplayText(){return"Claude"}getIcon(){return"message-square"}async onOpen(){this.containerEl=this.contentEl,this.containerEl.empty(),this.containerEl.addClass("claude-view-container"),this.buildHeader(),this.buildMessagesArea(),this.buildInputArea(),await this.checkClaudeStatus(),this.messages.length===0&&this.showEmptyState()}async onClose(){var e;(e=this.plugin.claudeService)==null||e.abort()}setSelectionContext(e){this.pendingSelectionContext=e,this.includeSelection=!0,this.updateContextToggles(),this.inputEl.focus()}buildHeader(){let e=this.containerEl.createDiv({cls:"claude-header"}),t=e.createDiv({cls:"claude-header-title-wrapper"});t.createSpan({text:"Claude",cls:"claude-header-title"}),this.statusIndicator=t.createSpan({cls:"claude-status-indicator"});let s=e.createDiv({cls:"claude-header-actions"}),o=s.createEl("button",{cls:"claude-header-button"});(0,d.setIcon)(o,"refresh-cw"),o.setAttribute("aria-label","New conversation"),o.onclick=()=>this.clearHistory();let n=s.createEl("button",{cls:"claude-header-button"});(0,d.setIcon)(n,"settings"),n.setAttribute("aria-label","Settings"),n.onclick=()=>{this.app.setting.open(),this.app.setting.openTabById("claude-for-obsidian")}}buildMessagesArea(){this.messagesContainer=this.containerEl.createDiv({cls:"claude-messages-container"})}buildInputArea(){let e=this.containerEl.createDiv({cls:"claude-input-container"}),t=e.createDiv({cls:"claude-context-options"});this.documentToggle=t.createEl("button",{cls:"claude-context-toggle",text:"\u{1F4C4} Current document"}),this.includeDocument&&this.documentToggle.addClass("active"),this.documentToggle.onclick=()=>this.toggleDocumentContext(),this.selectionToggle=t.createEl("button",{cls:"claude-context-toggle",text:"\u{1F50D} Selection"}),this.selectionToggle.onclick=()=>this.toggleSelectionContext();let s=e.createDiv({cls:"claude-input-wrapper"});this.inputEl=s.createEl("textarea",{cls:"claude-input",attr:{placeholder:"Ask Claude anything...",rows:"1"}}),this.inputEl.addEventListener("input",()=>{this.inputEl.style.height="auto",this.inputEl.style.height=Math.min(this.inputEl.scrollHeight,A.TEXTAREA_MAX_HEIGHT)+"px"}),this.inputEl.addEventListener("compositionstart",()=>{this.isComposing=!0}),this.inputEl.addEventListener("compositionend",()=>{this.isComposing=!1}),this.inputEl.addEventListener("keydown",o=>{o.key==="Enter"&&!o.shiftKey&&!this.isComposing&&(o.preventDefault(),this.sendMessage())}),this.sendButton=s.createEl("button",{cls:"claude-send-button",text:"Send"}),this.sendButton.onclick=()=>{this.isLoading?this.abortRequest():this.sendMessage()},e.createDiv({cls:"claude-input-hint",text:"Enter to send \xB7 Shift+Enter for new line"})}abortRequest(){var e;(e=this.plugin.claudeService)==null||e.abort(),this.setLoading(!1),new d.Notice("Request cancelled")}showEmptyState(){let e=this.messagesContainer.createDiv({cls:"claude-empty-state"});e.createDiv({cls:"claude-empty-state-icon",text:"\u{1F4AC}"}),e.createDiv({cls:"claude-empty-state-text",text:"Start a conversation with Claude. You can include the current document or selection as context."})}hideEmptyState(){let e=this.messagesContainer.querySelector(".claude-empty-state");e&&e.remove()}async checkClaudeStatus(){this.plugin.claudeService&&(this.cliStatus=await this.plugin.claudeService.checkAvailability(),this.updateStatusIndicator(),this.cliStatus.status!=="ready"&&this.showStatusMessage())}updateStatusIndicator(){this.statusIndicator.removeClass("claude-status-ready","claude-status-error"),this.cliStatus.status==="ready"?(this.statusIndicator.addClass("claude-status-ready"),this.statusIndicator.setAttribute("aria-label","Claude CLI ready")):(this.statusIndicator.addClass("claude-status-error"),this.statusIndicator.setAttribute("aria-label",this.cliStatus.message||"Claude CLI error"))}showStatusMessage(){let e=this.messagesContainer.createDiv({cls:"claude-error"});this.cliStatus.status==="not_installed"?e.innerHTML=`
        <strong>Claude CLI not installed</strong><br>
        Please install Claude CLI from <a href="https://claude.ai/download">claude.ai/download</a>
      `:this.cliStatus.status==="not_authenticated"?e.innerHTML=`
        <strong>Not authenticated</strong><br>
        Please run <code>claude login</code> in your terminal to authenticate.
      `:e.textContent=this.cliStatus.message||"Unknown error"}toggleDocumentContext(){this.includeDocument=!this.includeDocument,this.updateContextToggles()}toggleSelectionContext(){var e;if(this.includeSelection=!this.includeSelection,this.includeSelection){let t=(e=this.app.workspace.activeEditor)==null?void 0:e.editor;if(t){let s=t.getSelection();s?this.pendingSelectionContext=s:(new d.Notice("No text selected"),this.includeSelection=!1)}}else this.pendingSelectionContext=null;this.updateContextToggles()}updateContextToggles(){this.documentToggle.toggleClass("active",this.includeDocument),this.selectionToggle.toggleClass("active",this.includeSelection)}async sendMessage(){var c;let e=this.inputEl.value.trim();if(!e||this.isLoading)return;if(this.isLoading=!0,this.sendButton.disabled=!0,this.cliStatus.status!=="ready"){new d.Notice("Claude CLI is not ready. Please check the status."),this.setLoading(!1);return}this.hideEmptyState();let t,s="none",o;if(this.includeSelection&&this.pendingSelectionContext)t=this.pendingSelectionContext,s="selection";else if(this.includeDocument){let l=this.app.workspace.getActiveFile();l&&(t=await this.app.vault.read(l),s="document",o=l.name)}t&&t.length>this.plugin.settings.maxContextLength&&(t=t.substring(0,this.plugin.settings.maxContextLength),new d.Notice("Context was truncated due to length limit")),this.lastUserRequest={message:e,context:t,contextType:s,fileName:o},this.displayedDeniedTools.clear();let n={id:this.generateId(),role:"user",content:e,timestamp:Date.now()};this.addMessage(n),requestAnimationFrame(()=>{this.inputEl.value="",this.inputEl.style.height="auto"}),this.pendingSelectionContext=null,this.includeSelection=!1,this.updateContextToggles(),this.setLoading(!0);let a={id:this.generateId(),role:"assistant",content:"",timestamp:Date.now(),isStreaming:!0};this.addMessage(a);let r=await((c=this.plugin.claudeService)==null?void 0:c.sendMessage({message:e,context:t,contextType:s,fileName:o},l=>{a.content+=l,this.updateMessageContent(a.id,a.content)},void 0,(l,g)=>{this.showToolUseStatus(a.id,l,g)},l=>{this.handlePermissionDenials(a.id,l)}));a.isStreaming=!1,a.responseTimeMs=Date.now()-this.loadingStartTime,r&&!r.success?this.updateMessageContent(a.id,`**Error:** ${r.error}`,!0):this.showResponseTime(a.id,a.responseTimeMs),this.setLoading(!1),this.plugin.settings.autoCopyResponse&&(r!=null&&r.success)&&r.content&&(await navigator.clipboard.writeText(r.content),new d.Notice("Response copied to clipboard")),this.enforceHistoryLimit()}addMessage(e){this.messages.push(e),this.renderMessage(e),this.scrollToBottom()}renderMessage(e){let t=this.messagesContainer.createDiv({cls:`claude-message claude-message-${e.role}`,attr:{"data-id":e.id}});t.createDiv({cls:"claude-message-role",text:e.role==="user"?"You":"Claude"});let s=t.createDiv({cls:"claude-message-content"});e.role==="assistant"?(e.isStreaming&&!e.content?this.renderLoadingIndicator(s):d.MarkdownRenderer.render(this.app,e.content||"",s,"",this),!e.isStreaming&&e.content&&this.renderActionButtons(t,e)):s.textContent=e.content}renderLoadingIndicator(e){this.loadingStartTime=Date.now();let t=e.createDiv({cls:"claude-loading"});this.currentLoadingEl=t,t.createDiv({cls:"claude-loading-spinner"}),t.createSpan({cls:"claude-loading-text",text:"Claude is thinking..."}),t.createDiv({cls:"claude-loading-status"}).createDiv({cls:"claude-loading-pulse"})}updateLoadingStatus(e){if(this.currentLoadingEl){let t=this.currentLoadingEl.querySelector(".claude-loading-text");t&&(t.textContent=e)}}removeLoadingIndicator(){this.currentLoadingEl&&(this.currentLoadingEl.remove(),this.currentLoadingEl=null)}showResponseTime(e,t){let s=this.messagesContainer.querySelector(`[data-id="${e}"]`);if(!s)return;let o=s.querySelector(".claude-message-role");if(!o)return;let n=(t/1e3).toFixed(1),a=o.createSpan({cls:"claude-response-time"});a.textContent=` \xB7 ${n}s`}renderActionButtons(e,t){let s=e.createDiv({cls:"claude-message-actions"}),o=s.createEl("button",{cls:"claude-action-button",text:"Insert to document"});o.onclick=()=>this.insertToDocument(t.content);let n=s.createEl("button",{cls:"claude-action-button",text:"Copy"});n.onclick=()=>this.copyToClipboard(t.content);let a=s.createEl("button",{cls:"claude-action-button",text:"Save as note"});a.onclick=()=>this.saveAsNote(t.content)}updateMessageContent(e,t,s=!1){let o=this.messagesContainer.querySelector(`[data-id="${e}"]`);if(o){let n=o.querySelector(".claude-message-content");n&&(this.removeLoadingIndicator(),n.empty(),s&&n.addClass("claude-error"),d.MarkdownRenderer.render(this.app,t,n,"",this));let a=this.messages.find(r=>r.id===e);a&&!a.isStreaming&&!s&&(o.querySelector(".claude-message-actions")||this.renderActionButtons(o,a))}this.scrollToBottom()}insertToDocument(e){var s;let t=(s=this.app.workspace.activeEditor)==null?void 0:s.editor;t?(t.replaceSelection(e),new d.Notice("Inserted to document")):new d.Notice("No active editor")}async copyToClipboard(e){await navigator.clipboard.writeText(e),new d.Notice("Copied to clipboard")}async saveAsNote(e){let s=`Claude Response ${new Date().toISOString().replace(/[:.]/g,"-")}.md`;try{await this.app.vault.create(s,e),new d.Notice(`Saved as ${s}`)}catch(o){new d.Notice("Failed to save note")}}clearHistory(){var e;this.messages=[],this.messagesContainer.empty(),this.showEmptyState(),(e=this.plugin.claudeService)==null||e.clearSession(),new d.Notice("Conversation cleared")}enforceHistoryLimit(){let e=this.plugin.settings.historyLimit;if(this.messages.length>e){let t=this.messages.length-e;this.messages.splice(0,t).map(o=>o.id).forEach(o=>{let n=this.messagesContainer.querySelector(`[data-id="${o}"]`);n&&n.remove()})}}setLoading(e){this.isLoading=e,e?(this.sendButton.textContent="Stop",this.sendButton.addClass("claude-send-button-stop"),this.sendButton.disabled=!1):(this.sendButton.textContent="Send",this.sendButton.removeClass("claude-send-button-stop"),this.sendButton.disabled=!1,this.removeLoadingIndicator())}scrollToBottom(){this.messagesContainer.scrollTop=this.messagesContainer.scrollHeight}generateId(){return`msg-${Date.now()}-${Math.random().toString(36).substr(2,9)}`}handlePermissionDenials(e,t){let s=t.filter(l=>this.displayedDeniedTools.has(l.toolName)?!1:(this.displayedDeniedTools.add(l.toolName),!0));if(s.length===0)return;let o=this.messagesContainer.querySelector(`[data-id="${e}"]`);if(!o)return;let n=o.querySelector(".claude-message-content");if(!n)return;let a=n.querySelector(".claude-permission-denials");a||(a=n.createDiv({cls:"claude-permission-denials"}));let r=a.querySelector(".claude-denials-header")||a.createDiv({cls:"claude-denials-header"});r.empty(),r.createSpan({text:"\u26A0\uFE0F \uB2E4\uC74C \uB3C4\uAD6C\uAC00 \uAD8C\uD55C \uC5C6\uC774 \uC2E4\uD589\uB418\uC9C0 \uBABB\uD588\uC2B5\uB2C8\uB2E4:"});for(let l of s){if(a.querySelector(`[data-tool-denial="${l.toolName}"]`))continue;let p=a.createDiv({cls:"claude-denial-item",attr:{"data-tool-denial":l.toolName}});p.createSpan({cls:"claude-denial-tool-name",text:l.toolName});let y=p.createEl("button",{cls:"claude-denial-allow-btn",text:"\uD5C8\uC6A9"});y.onclick=()=>{var P;(P=this.plugin.claudeService)==null||P.allowTool(l.toolName),y.textContent="\uD5C8\uC6A9\uB428 \u2713",y.disabled=!0,y.addClass("allowed")}}let c=a.querySelector(".claude-retry-container");if(!c){c=a.createDiv({cls:"claude-retry-container"});let l=c.createEl("button",{cls:"claude-retry-btn",text:"\uBAA8\uB450 \uD5C8\uC6A9\uD558\uACE0 \uC7AC\uC2DC\uB3C4"});l.onclick=()=>this.allowAllAndRetry(t)}this.scrollToBottom()}async allowAllAndRetry(e){var o;for(let n of e)(o=this.plugin.claudeService)==null||o.allowTool(n.toolName);if(this.messagesContainer.querySelectorAll(".claude-denial-allow-btn:not(.allowed)").forEach(n=>{n.textContent="\uD5C8\uC6A9\uB428 \u2713",n.disabled=!0,n.addClass("allowed")}),this.messagesContainer.querySelectorAll(".claude-retry-btn").forEach(n=>{n.disabled=!0,n.textContent="\uC7AC\uC2DC\uB3C4 \uC911..."}),!this.lastUserRequest){new d.Notice("\uC7AC\uC2DC\uB3C4\uD560 \uC694\uCCAD\uC774 \uC5C6\uC2B5\uB2C8\uB2E4.");return}await this.retryLastRequest()}async retryLastRequest(){var c;if(!this.lastUserRequest||this.isLoading)return;let{message:e,context:t,contextType:s,fileName:o}=this.lastUserRequest;this.displayedDeniedTools.clear(),this.setLoading(!0);let n=Date.now(),a={id:this.generateId(),role:"assistant",content:"",timestamp:Date.now(),isStreaming:!0};this.addMessage(a);let r=await((c=this.plugin.claudeService)==null?void 0:c.sendMessage({message:e,context:t,contextType:s,fileName:o},l=>{a.content+=l,this.updateMessageContent(a.id,a.content)},void 0,(l,g)=>{this.showToolUseStatus(a.id,l,g)},l=>{this.handlePermissionDenials(a.id,l)}));a.isStreaming=!1,a.responseTimeMs=Date.now()-n,r&&!r.success?this.updateMessageContent(a.id,`**Error:** ${r.error}`,!0):this.showResponseTime(a.id,a.responseTimeMs),this.setLoading(!1),this.enforceHistoryLimit()}showToolUseStatus(e,t,s){(s==="pending"||s==="approved")&&this.updateLoadingStatus(`Using ${t}...`);let o=this.messagesContainer.querySelector(`[data-id="${e}"]`);if(!o)return;let n=o.querySelector(".claude-tool-status-container");if(!n){let c=o.querySelector(".claude-message-content");c&&(n=c.createDiv({cls:"claude-tool-status-container"}))}if(!n)return;let a=n.querySelector(`[data-tool="${t}"]`);if(!a){a=n.createDiv({cls:"claude-tool-use",attr:{"data-tool":t}});let c=a.createSpan({cls:"claude-tool-use-icon"});(0,d.setIcon)(c,"terminal"),a.createSpan({cls:"claude-tool-use-name",text:t}),a.createSpan({cls:"claude-tool-use-status"})}let r=a.querySelector(".claude-tool-use-status");if(r)switch(r.removeClass("claude-tool-use-status-pending","claude-tool-use-status-approved","claude-tool-use-status-denied"),s){case"pending":r.addClass("claude-tool-use-status-pending"),r.textContent="\uB300\uAE30 \uC911...";break;case"approved":r.addClass("claude-tool-use-status-approved"),r.textContent="\uC2B9\uC778\uB428";break;case"denied":r.addClass("claude-tool-use-status-denied"),r.textContent="\uAC70\uBD80\uB428";break}this.scrollToBottom()}};var u=require("obsidian"),C=class extends u.PluginSettingTab{constructor(i,e){super(i,e),this.plugin=e}display(){let{containerEl:i}=this;i.empty(),i.createEl("h2",{text:"Claude for Obsidian Settings"}),i.createEl("h3",{text:"Claude CLI"}),new u.Setting(i).setName("Claude CLI path").setDesc('Path to the Claude CLI executable. Default is "claude" (uses system PATH).').addText(t=>t.setPlaceholder("claude").setValue(this.plugin.settings.claudePath).onChange(async s=>{this.plugin.settings.claudePath=s||"claude",await this.plugin.saveSettings()})).addButton(t=>t.setButtonText("Test").onClick(async()=>{if(this.plugin.claudeService){let s=await this.plugin.claudeService.checkAvailability();s.status==="ready"?new u.Notice(`Claude CLI is ready! Version: ${s.version||"unknown"}`):new u.Notice(`Error: ${s.message}`)}})),i.createEl("h3",{text:"Context"}),new u.Setting(i).setName("Include current document by default").setDesc("Automatically include the active document as context when sending messages.").addToggle(t=>t.setValue(this.plugin.settings.includeCurrentNote).onChange(async s=>{this.plugin.settings.includeCurrentNote=s,await this.plugin.saveSettings()})),new u.Setting(i).setName("Maximum context length").setDesc("Maximum number of characters to include as context. Larger values may cause slower responses.").addText(t=>t.setPlaceholder("50000").setValue(String(this.plugin.settings.maxContextLength)).onChange(async s=>{let o=parseInt(s,10);!isNaN(o)&&o>0&&(this.plugin.settings.maxContextLength=o,await this.plugin.saveSettings())})),i.createEl("h3",{text:"System Prompt"}),new u.Setting(i).setName("System prompt").setDesc("Instructions prepended to every message. Use this to guide Claude's behavior.").addTextArea(t=>{t.setPlaceholder("Enter system prompt...").setValue(this.plugin.settings.systemPrompt).onChange(async s=>{this.plugin.settings.systemPrompt=s,await this.plugin.saveSettings()}),t.inputEl.rows=6,t.inputEl.cols=50,t.inputEl.style.width="100%"}),i.createEl("h3",{text:"Response"}),new u.Setting(i).setName("Auto-copy responses").setDesc("Automatically copy Claude responses to clipboard.").addToggle(t=>t.setValue(this.plugin.settings.autoCopyResponse).onChange(async s=>{this.plugin.settings.autoCopyResponse=s,await this.plugin.saveSettings()})),i.createEl("h3",{text:"History"}),new u.Setting(i).setName("History limit").setDesc("Maximum number of messages to keep in conversation history.").addText(t=>t.setPlaceholder("50").setValue(String(this.plugin.settings.historyLimit)).onChange(async s=>{let o=parseInt(s,10);!isNaN(o)&&o>0&&(this.plugin.settings.historyLimit=o,await this.plugin.saveSettings())})),i.createEl("h3",{text:"Permissions"}),new u.Setting(i).setName("Auto-approve read-only tools").setDesc("Automatically approve tools that only read data (View, Glob, Grep, etc.) without asking.").addToggle(t=>t.setValue(this.plugin.settings.autoApproveReadOnly).onChange(async s=>{this.plugin.settings.autoApproveReadOnly=s,await this.plugin.saveSettings()})),new u.Setting(i).setName("Remember approved tools").setDesc("Remember tools you approve during a session, so you won't be asked again for the same tool.").addToggle(t=>t.setValue(this.plugin.settings.rememberApprovedTools).onChange(async s=>{this.plugin.settings.rememberApprovedTools=s,await this.plugin.saveSettings()})),i.createEl("h3",{text:"Help"});let e=i.createDiv({cls:"claude-settings-help"});e.innerHTML=`
      <p><strong>Requirements:</strong></p>
      <ul>
        <li>Claude Code CLI must be installed on your system</li>
        <li>You must be logged in with your Claude Pro subscription</li>
      </ul>
      <p><strong>Installation:</strong></p>
      <ol>
        <li>Download Claude CLI from <a href="https://claude.ai/download">claude.ai/download</a></li>
        <li>Run <code>claude login</code> in your terminal</li>
        <li>Authenticate with your Claude Pro account</li>
      </ol>
      <p><strong>Troubleshooting:</strong></p>
      <ul>
        <li>If the CLI is not found, specify the full path (e.g., <code>/usr/local/bin/claude</code>)</li>
        <li>On Windows, use the full path including <code>.exe</code></li>
        <li>Ensure the CLI is in your system PATH or specify the full path above</li>
      </ul>
    `}};var L=require("child_process"),f=require("fs"),_=require("string_decoder");var m=class m{constructor(i="claude"){this.currentProcess=null;this.isAborted=!1;this.sessionId=null;this.allowedTools=new Set;this.autoApproveReadOnly=!0;this.rememberApprovedTools=!0;this.systemPrompt="";this.currentResolve=null;this.currentOnChunk=null;this.currentOnToolUse=null;this.onPermissionDenied=null;this.fullResponse="";this.lineBuffer="";this.decoder=new _.StringDecoder("utf-8");this.processedTexts=new Set;this.processedToolIds=new Set;this.processedMessageUuids=new Set;this.lastEventType=null;this.lastPermissionDenials=[];this.claudePath=i,m.DEFAULT_ALLOWED_TOOLS.forEach(e=>this.allowedTools.add(e))}getExtendedEnv(){let i=process.env.PATH||"",t=[...m.COMMON_PATHS.filter(s=>!i.includes(s)),i].join(":");return{...process.env,PATH:t,LANG:"en_US.UTF-8",LC_ALL:"en_US.UTF-8"}}updateSettings(i){i.claudePath!==void 0&&(this.claudePath=i.claudePath),i.autoApproveReadOnly!==void 0&&(this.autoApproveReadOnly=i.autoApproveReadOnly),i.rememberApprovedTools!==void 0&&(this.rememberApprovedTools=i.rememberApprovedTools),i.systemPrompt!==void 0&&(this.systemPrompt=i.systemPrompt)}allowTool(i){this.allowedTools.add(i)}disallowTool(i){this.allowedTools.delete(i)}getAllowedTools(){return Array.from(this.allowedTools)}resetAllowedTools(){this.allowedTools.clear(),m.DEFAULT_ALLOWED_TOOLS.forEach(i=>this.allowedTools.add(i))}clearSession(){this.sessionId=null,this.resetAllowedTools(),this.terminateProcess()}getSessionId(){return this.sessionId}getLastPermissionDenials(){return this.lastPermissionDenials}findClaudePath(){if(this.claudePath.startsWith("/")&&(0,f.existsSync)(this.claudePath))return this.claudePath;for(let i of m.COMMON_PATHS){let e=`${i}/claude`;if((0,f.existsSync)(e))try{return(0,f.realpathSync)(e)}catch(t){return e}}return this.claudePath}terminateProcess(){this.currentProcess&&(this.currentProcess.kill("SIGTERM"),this.currentProcess=null),this.resetBuffers()}resetBuffers(){this.fullResponse="",this.lineBuffer="",this.decoder=new _.StringDecoder("utf-8"),this.processedTexts.clear(),this.processedToolIds.clear(),this.processedMessageUuids.clear(),this.lastEventType=null,this.lastPermissionDenials=[]}handleStdout(i){if(this.isAborted)return;let e=this.decoder.write(i);this.lineBuffer+=e;let t=this.lineBuffer.split(`
`);this.lineBuffer=t.pop()||"";for(let s of t)this.processLine(s.trim())}processLine(i){var e;if(i)try{let t=JSON.parse(i);if(t.uuid&&this.processedMessageUuids.has(t.uuid))return;t.uuid&&this.processedMessageUuids.add(t.uuid);let s=t.type==="assistant"&&this.lastEventType!=="assistant",o=!1;this.handleStreamEvent(t,n=>{var a,r;s&&this.fullResponse.length>0&&!o&&(this.fullResponse+=`

`,(a=this.currentOnChunk)==null||a.call(this,`

`),o=!0),this.fullResponse+=n,(r=this.currentOnChunk)==null||r.call(this,n)}),this.lastEventType=t.type,t.type==="result"&&(t.permission_denials&&t.permission_denials.length>0&&(this.lastPermissionDenials=t.permission_denials.map(n=>({toolName:n.tool_name,toolInput:n.tool_input})),(e=this.onPermissionDenied)==null||e.call(this,this.lastPermissionDenials)),this.currentResolve&&(this.currentResolve({success:!t.is_error,content:this.fullResponse,error:t.error}),this.currentResolve=null))}catch(t){console.log("[ClaudeService] Non-JSON line:",i)}}async checkAvailability(){return new Promise(i=>{var e,t;try{let s=this.findClaudePath(),o=(0,L.spawn)(s,["--version"],{stdio:["pipe","pipe","pipe"],env:this.getExtendedEnv()}),n="",a="";(e=o.stdout)==null||e.on("data",r=>{n+=r.toString()}),(t=o.stderr)==null||t.on("data",r=>{a+=r.toString()}),o.on("error",r=>{r.code==="ENOENT"?i({status:"not_installed",message:"Claude CLI is not installed."}):i({status:"error",message:r.message})}),o.on("close",r=>{if(r===0){let c=n.match(/[\d.]+/);i({status:"ready",version:c?c[0]:void 0})}else i({status:"error",message:a||"Unknown error"})}),setTimeout(()=>{o.kill(),i({status:"error",message:"Timeout"})},b.VERSION_CHECK)}catch(s){i({status:"error",message:s instanceof Error?s.message:"Unknown error"})}})}async sendMessage(i,e,t,s,o){return new Promise(n=>{var a,r;this.isAborted=!1,this.currentResolve=n,this.currentOnChunk=e,this.currentOnToolUse=s||null,this.onPermissionDenied=o||null,this.resetBuffers();try{let c=this.findClaudePath(),l=i.message;i.context&&i.contextType!=="none"&&(l=`${i.fileName?`Document: ${i.fileName}`:"Context"}

${i.context}

---

User Question: ${i.message}`);let g=["-p","--output-format","stream-json","--verbose"];this.systemPrompt&&g.push("--append-system-prompt",this.systemPrompt),this.sessionId&&g.push("--resume",this.sessionId),this.allowedTools.size>0&&g.push("--allowedTools",Array.from(this.allowedTools).join(",")),console.log("[ClaudeService] Starting process with args:",g),console.log("[ClaudeService] Claude path:",c),this.currentProcess=(0,L.spawn)(c,g,{stdio:["pipe","pipe","pipe"],env:this.getExtendedEnv()}),(a=this.currentProcess.stdout)==null||a.on("data",p=>{this.handleStdout(p)}),(r=this.currentProcess.stderr)==null||r.on("data",p=>{console.error("[ClaudeService] stderr:",p.toString("utf-8"))}),this.currentProcess.stdin&&(this.currentProcess.stdin.write(l),this.currentProcess.stdin.end()),this.currentProcess.on("close",p=>{console.log("[ClaudeService] Process exited with code:",p),this.currentProcess=null,this.currentResolve&&(this.fullResponse?this.currentResolve({success:!0,content:this.fullResponse}):this.currentResolve({success:!1,error:`Process exited with code ${p}`}),this.currentResolve=null)}),this.currentProcess.on("error",p=>{console.error("[ClaudeService] Process error:",p),this.currentResolve&&(this.currentResolve({success:!1,error:p.message}),this.currentResolve=null)}),setTimeout(()=>{this.currentResolve===n&&(this.terminateProcess(),n({success:!1,error:"Request timed out after 5 minutes"}))},b.MESSAGE)}catch(c){n({success:!1,error:c instanceof Error?c.message:"Unknown error"})}})}handleStreamEvent(i,e){var t,s,o;if(i.session_id&&!this.sessionId&&(this.sessionId=i.session_id,console.log("[ClaudeService] Session ID saved:",this.sessionId)),i.type==="system"&&i.subtype==="init"){console.log("[ClaudeService] Session initialized"),console.log("[ClaudeService] Init event:",JSON.stringify(i,null,2));return}if(i.type==="assistant"&&((t=i.message)!=null&&t.content)){for(let n of i.message.content)if(n.type==="text"&&n.text)this.processedTexts.has(n.text)||(this.processedTexts.add(n.text),e(n.text));else if(n.type==="tool_use"&&n.name&&n.id){let a=n.name,r=n.id;if(this.processedToolIds.has(r))return;this.processedToolIds.add(r),console.log("[ClaudeService] Tool use:",a,"| ID:",r);let c=this.allowedTools.has(a);(s=this.currentOnToolUse)==null||s.call(this,a,c?"approved":"pending")}}if(i.type==="user"&&((o=i.message)!=null&&o.content))for(let n of i.message.content)n.type==="tool_result"&&n.tool_use_id&&console.log("[ClaudeService] Tool result for:",n.tool_use_id)}abort(){this.isAborted=!0,this.terminateProcess(),this.currentResolve&&(this.currentResolve({success:!1,error:"Request was cancelled"}),this.currentResolve=null)}isRunning(){return this.currentProcess!==null&&!this.currentProcess.killed}shutdown(){console.log("[ClaudeService] Shutting down..."),this.terminateProcess(),this.sessionId=null,this.allowedTools.clear()}};m.COMMON_PATHS=["/opt/homebrew/bin","/usr/local/bin","/usr/bin","/home/linuxbrew/.linuxbrew/bin",`${process.env.HOME}/.local/bin`,`${process.env.HOME}/.claude/local`],m.DEFAULT_ALLOWED_TOOLS=["View","Read","Glob","Grep","LS","GlobTool","GrepTool","ReadNotebook","mcp__mcp-obsidian__obsidian_list_files_in_dir","mcp__mcp-obsidian__obsidian_list_files_in_vault","mcp__mcp-obsidian__obsidian_get_file_contents","mcp__mcp-obsidian__obsidian_simple_search","mcp__mcp-obsidian__obsidian_complex_search","mcp__mcp-obsidian__obsidian_batch_get_file_contents","mcp__mcp-obsidian__obsidian_get_periodic_note","mcp__mcp-obsidian__obsidian_get_recent_periodic_notes","mcp__mcp-obsidian__obsidian_get_recent_changes"];var T=m;var E=class extends R.Plugin{constructor(){super(...arguments);this.settings=x;this.claudeService=null}async onload(){await this.loadSettings(),this.claudeService=new T(this.settings.claudePath),this.claudeService.updateSettings({autoApproveReadOnly:this.settings.autoApproveReadOnly,rememberApprovedTools:this.settings.rememberApprovedTools,systemPrompt:this.settings.systemPrompt}),this.registerView(v,e=>new S(e,this)),this.addRibbonIcon("message-square","Open Claude",()=>{this.activateView()}),this.addCommand({id:"open-claude-view",name:"Open Claude Chat",callback:()=>{this.activateView()}}),this.addCommand({id:"send-selection-to-claude",name:"Send Selection to Claude",editorCallback:e=>{let t=e.getSelection();t&&this.activateView().then(s=>{s&&s.setSelectionContext(t)})}}),this.addSettingTab(new C(this.app,this)),this.checkClaudeStatus()}onunload(){var e;(e=this.claudeService)==null||e.shutdown()}async loadSettings(){this.settings=Object.assign({},x,await this.loadData())}async saveSettings(){await this.saveData(this.settings),this.claudeService&&this.claudeService.updateSettings({claudePath:this.settings.claudePath,autoApproveReadOnly:this.settings.autoApproveReadOnly,rememberApprovedTools:this.settings.rememberApprovedTools,systemPrompt:this.settings.systemPrompt})}async activateView(){let{workspace:e}=this.app,t=null,s=e.getLeavesOfType(v);return s.length>0?t=s[0]:(t=e.getRightLeaf(!1),t&&await t.setViewState({type:v,active:!0})),t?(e.revealLeaf(t),t.view):null}async checkClaudeStatus(){if(this.claudeService){let e=await this.claudeService.checkAvailability();e.status!=="ready"&&console.log("Claude CLI status:",e)}}};
